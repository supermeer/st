<view class="chat-container" style="height: {{contentHeight}};padding-top: {{safeAreaTop}}px; padding-bottom: {{ keyboardHeight <= 0 && showBack ? safeAreaBottom : 0 }}px;">
  <!-- <t-image class="bg-image" src="/static/home/bg.png" mode="aspectFill" /> -->
  <view class="role-info-container">
    <view wx:if="{{showBack}}" bindtap="onBack">
      <t-icon name="chevron-left" class="back-icon" size="26" color="#fff" />
    </view>
    <view class="role-info" bindtap="goRoleInfo">
      <t-image class="role-avatar" src="{{avatarUrl}}" mode="aspectFill" />
      <view class="role-msg">
        <text class="role-name">{{roleDetail.name}}</text>
        <!-- <text class="role-job">{{roleDetail.description}}</text> -->
      </view>
    </view>
  </view>
  <scroll-view 
    class="message-list"
    scroll-y="{{true}}" 
    scroll-into-view="{{intoViewId}}" 
    scroll-with-animation="{{scrollAnimation}}" 
    show-scrollbar="{{false}}"
    refresher-enabled="{{hasMore && !maskVisible}}"
    refresher-triggered="{{refresherTriggered}}"
    refresher-threshold="{{50}}"
    refresher-background="transparent"
    bindrefresherrefresh="onLoadMore"
    bindrefresherpulling="onPulling"
    bindrefresherrestore="onRestore"
    bindscroll="onScroll"
    enable-passive="{{true}}"
  >
    <!-- 下拉加载提示 -->
    <view class="loading-more-tip">
      <view wx:if="{{pullDownStatus === 'pull'}}" class="tip-content">
        <text class="tip-text">下拉加载更多</text>
      </view>
      <view wx:elif="{{pullDownStatus === 'release'}}" class="tip-content">
        <text class="tip-text">松开加载更多</text>
      </view>
      <view wx:elif="{{pullDownStatus === 'loading'}}" class="tip-content">
        <view class="loading-icon"></view>
        <text class="tip-text">加载中...</text>
      </view>
      <view wx:elif="{{pullDownStatus === 'nomore'}}" class="tip-content">
        <text class="tip-text">没有更多了</text>
      </view>
    </view>
    <view class="plot-box blur-glass">
      <view class="plot-title">
        <t-image class="plot-icon" src="/static/chat/juqing.png" />
        <text>剧情</text>
      </view>
      <text class="plot-content">{{sceneNeedFold ? sceneDisplay : currentStoryDetail.scene}}</text>
      <text wx:if="{{sceneNeedFold}}" class="fold-toggle" bind:tap="toggleScene">
        {{sceneExpanded ? '收起 ▴' : '展开 ▾'}}
      </text>
    </view>
    <view wx:for="{{msgList}}" wx:key="id" id="msg-{{item.id}}">
      <role-msg wx:if="{{item.senderType === 2}}" class="message-item" message="{{item}}" isLatest="{{index === msgList.length - 1}}" disabled="{{isGenerating}}" bind:buttonClick="onButtonClick" bind:maskShow="onMaskShow" />
      <user-msg wx:if="{{item.senderType === 1}}" class="message-item" message="{{item}}" disabled="{{isGenerating}}" bind:buttonClick="onButtonClick" bind:maskShow="onMaskShow" />
    </view>
    <view wx:if="{{msgList.length > 0 && msgList[msgList.length - 1].error}}" class="retry-container">
      <t-icon name="unhappy-1" class="icon-btn" size="18px" />
      有点迷失啦，请点击
      <text class="retry-text" bindtap="onRetry">重新尝试</text>
    </view>
    <view id="bottom-anchor" style="height: 1rpx;"></view>
  </scroll-view>
  <input-box
    class="input-box"
    plotId="{{chatDetail.plotId}}"
    roleInfo="{{roleDetail}}"
    disabled="{{isGenerating}}"
    bind:keyboardHeightChange="onKeyboardHeightChange"
    bind:inputLineChange="onInputLineChange"
    bind:hideTabbar="hideTabbar"
    bind:showTabbar="showTabbar"
    bind:sendMessage="sendMessage"
    bind:buttonClick="onButtonClick"
  />
</view>

<block wx:if="{{maskVisible}}">
  <view 
    class="global-action-mask"
    catchtap="hideMask"
    catchtouchmove="preventMove"
  >
  </view>
  
  <!-- AI消息按钮弹窗（左侧） -->
  <view 
    wx:if="{{currentMessageType === 'role'}}"
    class="global-action-buttons buttons-show"
    style="position: fixed; top: {{maskButtonTop}}px; left: {{maskButtonLeft}}px; z-index: 10001;"
    catchtap="stopPropagation"
  >
    <view class="action-btn" catchtap="onMaskButtonClick" data-action="rollback">
      <t-image class="action-icon" src="/static/chat/huisu.png" />
      <text>回溯</text>
    </view>
    <view class="action-btn" catchtap="onMaskButtonClick" data-action="newPlot">
      <t-image class="action-icon" src="/static/chat/juqing.png" />
      <text>新剧情</text>
    </view>
  </view>
  
  <!-- 用户消息按钮弹窗（右侧） -->
  <view 
    wx:if="{{currentMessageType === 'user'}}"
    class="global-action-buttons buttons-show"
    style="position: fixed; top: {{maskButtonTop}}px; right: {{maskButtonRight}}px; z-index: 10001;"
    catchtap="stopPropagation"
  >
    <view class="action-btn" catchtap="onMaskButtonClick" data-action="rollback" data-include="true">
      <t-icon name="rollback" size="32rpx" class="action-icon" />
      <text>撤回</text>
    </view>
  </view>
</block>

<tip-dialog id="tip-dialog" />
<input-sheet id="input-sheet" />
<select-sheet id="select-sheet" />