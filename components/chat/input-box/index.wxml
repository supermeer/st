<view class="input-box-container {{disabled ? 'disabled' : ''}}">
  <!-- 禁用状态遮罩层：统一拦截所有交互 -->
  <view wx:if="{{disabled}}" class="disabled-mask" catchtap="onDisabledTap" catchtouchmove="onDisabledTap"></view>
  
  <!-- 语音录音浮层 -->
  <view wx:if="{{isRecording || voiceStatus}}" class="voice-modal">
    <view class="voice-modal-content {{isTouchMoving ? 'voice-modal-cancel' : ''}}">
      <!-- 录音中 -->
      <view wx:if="{{voiceStatus == 'recording'}}" class="voice-status-box">
        <view class="voice-animation">
          <view class="voice-wave"></view>
          <view class="voice-wave"></view>
          <view class="voice-wave"></view>
          <t-icon name="microphone-1-filled" class="voice-icon" size="80rpx" />
        </view>
        <view class="voice-tip">{{isTouchMoving ? '松开取消' : '正在录音...'}}</view>
        <view class="voice-time" style="{{recordTime >= (inputDuration - 5) ? 'color: #ff4444;' : ''}}">{{recordTime}}s / {{inputDuration}}s</view>
        <view class="voice-cancel-tip" wx:if="{{!isTouchMoving && recordTime < (inputDuration - 5)}}">上滑取消</view>
        <view class="voice-warning" wx:if="{{recordTime >= (inputDuration - 5) && !isTouchMoving}}">即将自动结束</view>
      </view>
      <!-- 识别中 -->
      <view wx:if="{{voiceStatus == 'recognizing'}}" class="voice-status-box">
        <view class="voice-loading">
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
          <view class="loading-dot"></view>
        </view>
        <view class="voice-tip">识别中...</view>
      </view>
    </view>
  </view>
  
  <view wx:if="{{inputType != 1}}" class="input-box {{isRecording ? 'input-box-recording' : ''}}">
    <t-image wx:if="{{inputType == 2}}" class="input-box-image" src="/static/chat/yuyin.png" data-type="0" bindtap="changeInputType" />
    <t-image wx:if="{{inputType == 0}}" class="input-box-image" src="/static/chat/jianpan.png" data-type="2" bindtap="changeInputType" />
    <view class="input-box-text" wx:if="{{inputType == 0}}" bindtap="changeInputType" data-type="1">{{inputValue || '对ta说'}}</view>
    <view 
      class="input-box-text input-box-text__audio" 
      wx:if="{{inputType == 2}}"
      bindtouchstart="onVoiceTouchStartRecord"
      bindtouchmove="onVoiceTouchMove"
      bindtouchend="onVoiceTouchEnd"
      bindtouchcancel="onVoiceTouchEnd"
    >
      {{isRecording ? '松开发送' : '按住说话'}}
    </view>
    <t-image wx:if="{{!showInspiration}}" class="input-box-image" src="/static/chat/linggan.png" bindtap="showInspiration" />
    <t-image wx:else class="input-box-image" src="/static/chat/linggan_active.png" bindtap="showInspiration" />
    <t-image wx:if="{{!showBoard}}" class="input-box-image" src="/static/chat/add.png" bindtap="showBoard" />
    <t-image wx:else class="input-box-image" src="/static/chat/add_active.png" bindtap="showBoard" />
  </view>
  <view wx:if="{{inputType == 1}}" class="input-box-input">
    <t-textarea
      class="input-box-textarea"
      value="{{inputValue}}"
      focus="{{focus}}"
      hold-keyboard="{{false}}"
      show-confirm-bar="{{false}}"
      autosize="{{inputConfig}}"
      placeholder="发送消息，环境、动作等可写在括号里"
      bind:blur="onInputBlur"
      bind:change="onInput"
      confirm-type="send"
      maxlength="1000"
      adjust-position="{{false}}"
      bind:line-change="onInputLineChange"
      bind:enter="onSend"
    />
    <view class="bottom-line">
      <!-- <t-image class="bracket-icon input-box-image" src="/static/chat/bracket.png" bindtap="addBracket" /> -->
      <t-image class="input-box-image" src="/static/chat/linggan.png" bindtap="showInspiration" />
      <view class="icon-wrapper">
        <view class="icon-item icon-add-wrapper" style="opacity: {{inputValue && inputValue.length > 0 ? 0 : 1}}; pointer-events: {{inputValue && inputValue.length > 0 ? 'none' : 'auto'}};">
          <t-image class="input-box-image" src="/static/chat/add.png" bindtap="showBoard" />
        </view>
        <view class="icon-item icon-send-wrapper" style="opacity: {{!inputValue || inputValue.length == 0 ? 0 : 1}}; pointer-events: {{!inputValue || inputValue.length == 0 ? 'none' : 'auto'}};" bindtap="onSend">
          <t-image class="input-box-image" src="/static/chat/send.png" />
        </view>
      </view>
    </view>
  </view>
  <view wx:if="{{showInspiration}}" class="input-box-inspiration">
    <view class="input-box-inspiration-title">
      灵感对话
      <t-icon name="refresh" class="icon-btn" size="18px" bindtap="refreshInspiration" />
    </view>
    <!-- 加载中状态 -->
    <view wx:if="{{inspirationLoading}}" class="input-box-inspiration-loading">
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
      <view class="loading-dot"></view>
    </view>
    <!-- 空状态 -->
    <view wx:elif="{{inspirationEmpty}}" class="input-box-inspiration-empty">
      <text>暂时没有灵感，尝试换一句话或多聊几句吧～</text>
    </view>
    <!-- 正常列表 -->
    <view wx:else>
      <view wx:for="{{inspirationList}}" wx:key="index" class="input-box-inspiration-item" data-item="{{item}}" bindtap="onInspirationTap">
        {{item}}
        <t-icon name="edit-2-filled" class="icon-btn" size="28rpx" data-item="{{item}}" catchtap="editInspiration" />
      </view>
    </view>
  </view>
  <view wx:if="{{showBoard}}" class="input-box-board">
    <view class="input-box-board-item" bindtap="restart">
      <t-image class="board-box-image" src="/static/chat/chongxinkaishi.png" />
      <text>重新开始</text>
    </view>
    <view class="input-box-board-item" bindtap="uploadImage">
      <t-image class="board-box-image" src="/static/chat/tupian.png" />
      <text>图片</text>
    </view>
    <view class="input-box-board-item" bindtap="storyList">
      <t-image class="board-box-image" src="/static/chat/juqing.png" />
      <text>其他剧情</text>
    </view>
    <button class="input-box-board-item" open-type="share">
      <t-image class="board-box-image" src="/static/chat/fenxiang.png" />
      <text>分享</text>
    </button>
    <!-- <view class="input-box-board-item" bindtap="report">
      <t-image class="board-box-image" src="/static/chat/jubao.png" />
      <text>举报</text>
    </view> -->
    <view class="input-box-board-item" bindtap="cs">
      <t-image class="board-box-image" src="/static/chat/kf.png" />
      <text>联系客服</text>
    </view>
  </view>
</view>

<image-uploader
  visible="{{showUploader}}"
  bind:success="onUploadSuccess"
  bind:fail="onUploadFail"
  bind:cancel="onUploadCancel"
/>